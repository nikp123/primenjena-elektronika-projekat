#include <stdlib.h>
#include <stdint.h>
#include <string.h>

#include "driverGLCD.h"
#include "adc.h"
#include "alarm.h"
#include "lcd.h"
#include "touchscreen.h"
#include "uart.h"

#include "unos_sifre.h"

// Staticke varijable i definicije

#define KEYPAD_HEIGHT 64
#define KEYPAD_WIDTH 128

// Definicija pozicija svih dugmadi na ekranu
static bound BUTTON_CLEAR = {
    .x_low  = 88,
    .x_high = 124,
    .y_low  = 23,
    .y_high = 40
};
static bound BUTTON_0 = {
    .x_low  = 66,
    .x_high = 83,
    .y_low  = 23,
    .y_high = 40
};
static bound BUTTON_1 = {
    .x_low  = 3,
    .x_high = 20,
    .y_low  = 43,
    .y_high = 60
};
static bound BUTTON_2 = {
    .x_low  = 24,
    .x_high = 41,
    .y_low  = 43,
    .y_high = 60
};
static bound BUTTON_3 = {
    .x_low  = 45,
    .x_high = 62,
    .y_low  = 43,
    .y_high = 60
};
static bound BUTTON_4 = {
    .x_low  = 3,
    .x_high = 20,
    .y_low  = 24,
    .y_high = 40
};
static bound BUTTON_5 = {
    .x_low  = 24,
    .x_high = 41,
    .y_low  = 24,
    .y_high = 40
};
static bound BUTTON_6 = {
    .x_low  = 45,
    .x_high = 62,
    .y_low  = 24,
    .y_high = 40
};
static bound BUTTON_7 = {
    .x_low  = 3,
    .x_high = 20,
    .y_low  = 3,
    .y_high = 20
};
static bound BUTTON_8 = {
    .x_low  = 24,
    .x_high = 41,
    .y_low  = 3,
    .y_high = 20
};
static bound BUTTON_9 = {
    .x_low  = 45,
    .x_high = 62,
    .y_low  = 3,
    .y_high = 20
};

static bound BUTTON_ENTER = {
    .x_low  = 88,
    .x_high = 124,
    .y_low  = 3,
    .y_high = 20
};

// Slika ekrana za unos
static const uint8_t keypad[]  = {
  0x00, 0x00, 0x00, 0xf8, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x88, 0x88, 0xc8, 0xc8, 0x08, 0x08, 
  0x08, 0x08, 0x08, 0x08, 0xf8, 0x00, 0x00, 0x00, 0xf8, 0x08, 0x08, 0x08, 0x08, 0x08, 0x88, 0xc8, 
  0x48, 0x48, 0x48, 0xc8, 0x88, 0x08, 0x08, 0x08, 0x08, 0xf8, 0x00, 0x00, 0x00, 0xf8, 0x08, 0x08, 
  0x08, 0x08, 0x08, 0x88, 0xc8, 0x48, 0x48, 0xc8, 0x88, 0x08, 0x08, 0x08, 0x08, 0x08, 0xf8, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x02, 0x03, 0x01, 0x00, 0xff, 0xff, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x81, 0xe1, 
  0x70, 0x38, 0x1c, 0x0f, 0x07, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xc1, 0xc1, 0x08, 0x08, 0x0f, 0xf7, 0xf3, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x9f, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x91, 0x91, 0x90, 0x90, 
  0x90, 0x90, 0x90, 0x90, 0x9f, 0x00, 0x00, 0x00, 0x9f, 0x90, 0x90, 0x90, 0x90, 0x90, 0x91, 0x91, 
  0x91, 0x91, 0x91, 0x91, 0x91, 0x90, 0x90, 0x90, 0x90, 0x9f, 0x00, 0x00, 0x00, 0x9f, 0x90, 0x90, 
  0x90, 0x90, 0x90, 0x90, 0x91, 0x91, 0x91, 0x91, 0x91, 0x90, 0x90, 0x90, 0x90, 0x90, 0x9f, 0x00, 
  0x00, 0x00, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 
  0x90, 0x90, 0x90, 0x90, 0x10, 0x10, 0x10, 0x10, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 
  0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 
  0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe0, 0x70, 0x18, 0xfc, 0xfc, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xfc, 
  0x44, 0x44, 0x44, 0xc4, 0x80, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 
  0x00, 0x00, 0xe0, 0xf8, 0x8c, 0x44, 0x44, 0xcc, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 
  0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xf8, 0x0c, 0x06, 0x06, 0x0c, 0xf8, 0xc0, 0x00, 
  0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x80, 0xc0, 0x40, 0x40, 0xc0, 
  0x80, 0x00, 0xf8, 0xf8, 0x00, 0x00, 0x80, 0xc0, 0x40, 0x40, 0xc0, 0x80, 0x00, 0x80, 0xc0, 0x40, 
  0x40, 0xc0, 0x80, 0x00, 0x00, 0xc0, 0x80, 0xc0, 0x40, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x02, 0x02, 0x1f, 0x1f, 0x02, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x1c, 
  0x10, 0x10, 0x10, 0x0f, 0x07, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 
  0x00, 0x00, 0x07, 0x0f, 0x18, 0x10, 0x10, 0x18, 0x0f, 0x07, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 
  0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0f, 0x18, 0x30, 0x30, 0x18, 0x0f, 0x01, 0x00, 
  0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x0f, 0x1f, 0x10, 0x10, 0x18, 
  0x08, 0x00, 0x1f, 0x1f, 0x00, 0x00, 0x0f, 0x1f, 0x11, 0x11, 0x19, 0x09, 0x00, 0x0c, 0x1e, 0x13, 
  0x11, 0x1f, 0x1f, 0x00, 0x00, 0x1f, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xf9, 0x09, 0x09, 0x09, 0x09, 0x09, 0xc9, 0xc9, 0x49, 0x49, 0x49, 0xc9, 0xc9, 
  0x09, 0x09, 0x09, 0x09, 0xf9, 0x00, 0x00, 0x00, 0xf9, 0x09, 0x09, 0x09, 0x09, 0x09, 0x89, 0xc9, 
  0x49, 0x49, 0xc9, 0x89, 0x09, 0x09, 0x09, 0x09, 0x09, 0xf9, 0x00, 0x00, 0x00, 0xf9, 0x09, 0x09, 
  0x09, 0x09, 0x09, 0x89, 0xc9, 0x49, 0x49, 0xc9, 0x89, 0x09, 0x09, 0x09, 0x09, 0x09, 0xf9, 0x00, 
  0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 
  0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0xf9, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 
  0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x89, 0x89, 0x09, 0x09, 0x09, 0x09, 
  0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0xf9, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xfc, 0x0f, 0x03, 0x01, 
  0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x63, 0xf7, 0x9c, 
  0x08, 0x08, 0x9c, 0xf7, 0x63, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0xcf, 0x98, 0x10, 0x10, 0x98, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x7c, 0xfe, 0x8a, 0x8a, 0xce, 
  0x4c, 0x00, 0xfe, 0xfe, 0x02, 0x02, 0xfe, 0xfc, 0x00, 0x02, 0x7f, 0xff, 0x82, 0x00, 0x7c, 0xfe, 
  0x8a, 0x8a, 0xce, 0x4c, 0x00, 0x00, 0xfe, 0xfc, 0x06, 0x02, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x1f, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x10, 0x10, 0x10, 
  0x10, 0x10, 0x10, 0x10, 0x1f, 0x00, 0x00, 0x00, 0x1f, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x11, 
  0x11, 0x11, 0x11, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 0x00, 0x00, 0x00, 0x1f, 0x10, 0x10, 
  0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x11, 0x11, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 
  0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 
  0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 0x00, 0x00, 0x00
};

// Globalne promenjive

// trenutni unosa
char unos[5] = { '\0' };
uint8_t unos_ptr = 0;

// ovo je sifra naspram koje se vrsi provera
char sifra[5] = { '\0' };

void refreshGLCD(void) {
    // Crtanje ekrana za unos
    draw(keypad);
    
    // Crtanje trenutnog unosa sifre
    GoToXY(66,1);
    if(unos_ptr > 0) {
        GLCD_Printf (unos);
    }
}

// Brisanje i nanovo crtanje LCDa
void clearGLCD(void) {
    GLCD_ClrScr();
    refreshGLCD();
}

// Dodaje se karakter unosa
void unos_add(uint8_t a) {
    if(unos_ptr == 4) return;
    
    unos[unos_ptr] = a + '0';
    unos_ptr++;

    clearGLCD();
}

// Brisanje unosa sifre
void unos_sifre_clear() {
    unos_ptr = 0;
    
    uint8_t i;
    for(i = 0; i < 5; i++)
        unos[i] = '\0';
    
    clearGLCD();
}

// Pri pocetku rada sistema, brisemo sifru
void unos_sifre_reset() {
    uint8_t i;
    for(i=0; i < 5; i++) {
        sifra[i] = '\0';
    }
}

// setujemo inicijalnu sifru
void unos_sifre_set() {
    uint8_t i;
    for(i=0; i < 5; i++) {
        sifra[i] = unos[i];
    }
}

void unos_sifre_init() {
    alarm_arm();         // Pali se odbrojavanje alarma
    unos_sifre_clear();  // Brise se trenutni unos sifre
}

void unos_sifre_override(char *a) {
    // Ogranici prenos sifre do samo 4 karaktera
    // Jer bez ove provere haker moze da korupira memoriju
    strncpy(unos, a, 4);
}

bool unos_sifre_is_correct() {
    if(!strncmp(unos, sifra, 4)) {
        alarm_disarm(); // Gasi se odbrojavanje ako je sifra tacna
        return true;
    } else return false;
}

bool unos_sifre(void) {
    unsigned int X, Y;
    // Uzmi kordinate za trenutni unos
    touchscreen_coords(&X, &Y);
        
    // Korisnik zeli da obrise trenutni unos
    if (touchscreen_bound_hit(BUTTON_CLEAR, X, Y)){
        unos_sifre_clear();
    }
        
    if (touchscreen_bound_hit(BUTTON_ENTER, X, Y)){        
        // Ako su sva cetri karaktera unesena i korisnik potvrdjuje unos,
        // mozemo da smatramo da je unos zavrsen
        if(unos_ptr == 4) {
            uart1_writeln("Sifra unesena");
            uart1_writeln(unos);
            return true;
        }
    }

    // Proveravamo i izvrsavamo unos karaktera
    if (touchscreen_bound_hit(BUTTON_0, X, Y)){
        unos_add(0);
    } else if (touchscreen_bound_hit(BUTTON_1, X, Y)){
        unos_add(1);
    } else if (touchscreen_bound_hit(BUTTON_2, X, Y)){
        unos_add(2);
    } else if (touchscreen_bound_hit(BUTTON_3, X, Y)){
        unos_add(3);
    } else if (touchscreen_bound_hit(BUTTON_4, X, Y)){
        unos_add(4);
    } else if (touchscreen_bound_hit(BUTTON_5, X, Y)){
        unos_add(5);
    } else if (touchscreen_bound_hit(BUTTON_6, X, Y)){
        unos_add(6);
    } else if (touchscreen_bound_hit(BUTTON_7, X, Y)){
        unos_add(7);
    } else if (touchscreen_bound_hit(BUTTON_8, X, Y)){
        unos_add(8);
    } else if (touchscreen_bound_hit(BUTTON_9, X, Y)){
        unos_add(9);
    }
    
    return false; // unos nije zavrsen
}//main

			
		
												
